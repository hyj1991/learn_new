# è½»æ¾æ’æŸ¥çº¿ä¸ŠNodeå†…å­˜æ³„æ¼é—®é¢˜

## I. ä¸‰ç§æ¯”è¾ƒå…¸å‹çš„å†…å­˜æ³„æ¼

### ä¸€. é—­åŒ…å¼•ç”¨å¯¼è‡´çš„æ³„æ¼

è¿™æ®µä»£ç å·²ç»åœ¨å¾ˆå¤šè®²è§£å†…å­˜æ³„æ¼çš„åœ°æ–¹å¼•ç”¨äº†ï¼Œéå¸¸ç»å…¸ï¼Œæ‰€ä»¥æ‹¿å‡ºæ¥ä½œä¸ºç¬¬ä¸€ä¸ªä¾‹å­ï¼Œä»¥ä¸‹æ˜¯æ³„æ¼ä»£ç ï¼š


```js
'use strict';
const express = require('express');
const app = express();

//ä»¥ä¸‹æ˜¯äº§ç”Ÿæ³„æ¼çš„ä»£ç 
let theThing = null;
let replaceThing = function () {
    let leak = theThing;
    let unused = function () {
        if (leak)
            console.log("hi")
    };
    
    // ä¸æ–­ä¿®æ”¹theThingçš„å¼•ç”¨
    theThing = {
        longStr: new Array(1000000),
        someMethod: function () {
            console.log('a');
        }
    };
};

app.get('/leak', function closureLeak(req, res, next) {
    replaceThing();
    res.send('Hello Node');
});

app.listen(8082);

```

jsä¸­çš„é—­åŒ…éå¸¸æœ‰æ„æ€ï¼Œé€šè¿‡æ‰“å°heapsnapshotï¼Œåœ¨chromeçš„dev toolsä¸­å±•ç¤ºï¼Œä¼šå‘ç°é—­åŒ…ä¸­çœŸæ­£å­˜å‚¨æœ¬ä½œç”¨åŸŸæ•°æ®çš„æ˜¯ç±»å‹ä¸º ```closure``` çš„ä¸€ä¸ªå‡½æ•°ï¼ˆå…¶__proto__æŒ‡å‘çš„functionï¼‰çš„ ```context``` å±æ€§æŒ‡å‘çš„å¯¹è±¡ã€‚

è¿™ä¸ªä¾‹å­ä¸­æ³„æ¼å¼•èµ·çš„åŸå› å°±æ˜¯v8å¯¹ä¸Šè¿°çš„ ```context``` é€‰æ‹©æ€§æŒæœ‰æœ¬ä½œç”¨åŸŸçš„æ•°æ®çš„ä¸¤ä¸ªç‰¹ç‚¹ï¼š

 * çˆ¶ä½œç”¨åŸŸçš„æ‰€æœ‰å­ä½œç”¨åŸŸæŒæœ‰çš„é—­åŒ…å¯¹è±¡æ˜¯åŒä¸€ä¸ªã€‚
 * è¯¥é—­åŒ…å¯¹è±¡æ˜¯å­ä½œç”¨åŸŸé—­åŒ…å¯¹è±¡ä¸­çš„ ```context``` å±æ€§æŒ‡å‘çš„å¯¹è±¡ï¼Œå¹¶ä¸”å…¶ä¸­åªä¼šåŒ…å«æ‰€æœ‰çš„å­ä½œç”¨åŸŸä¸­ä½¿ç”¨åˆ°çš„çˆ¶ä½œç”¨åŸŸå˜é‡ã€‚


### äºŒ. åŸç”ŸSocketé‡è¿ç­–ç•¥ä¸æ°å½“å¯¼è‡´çš„æ³„æ¼

è¿™ç§ç±»å‹çš„æ³„æ¼æœ¬è´¨ä¸Šnodeä¸­çš„eventsæ¨¡å—é‡Œçš„ä¾¦å¬å™¨æ³„æ¼ï¼Œå› ä¸ºæ¯”è¾ƒéšè”½ï¼Œæ‰€ä»¥æ”¾åœ¨ç¬¬äºŒä¸ªä¾‹å­ï¼Œä»¥ä¸‹æ˜¯æ³„æ¼ä»£ç ï¼š

```js
const net = require('net');
let client = new net.Socket();

function connect() {
    client.connect(26665, '127.0.0.1', function callbackListener() {
    console.log('connected!');
});
}

//ç¬¬ä¸€æ¬¡è¿æ¥
connect();

client.on('error', function (error) {
    // console.error(error.message);
});

client.on('close', function () {
    //console.error('closed!');
    //æ³„æ¼ä»£ç 
    client.destroy();
    setTimeout(connect, 1);
});

```

æ³„æ¼äº§ç”Ÿçš„åŸå› å…¶å®ä¹Ÿå¾ˆç®€å•ï¼š```event.js``` æ ¸å¿ƒæ¨¡å—å®ç°çš„äº‹ä»¶å‘å¸ƒ/è®¢é˜…æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªjså¯¹è±¡ç»“æ„ï¼ˆåœ¨v6ç‰ˆæœ¬ä¸­ä¸ºäº†æ€§èƒ½é‡‡ç”¨äº†new EventHandles()ï¼Œå¹¶ä¸”æŠŠEventHandlesçš„åŸå‹ç½®ä¸ºnullæ¥èŠ‚çœåŸå‹é“¾æŸ¥æ‰¾çš„æ¶ˆè€—ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬æ¯ä¸€æ¬¡è°ƒç”¨ ```event.on``` æˆ–è€… ```event.once``` ç›¸å½“äºåœ¨è¿™ä¸ªå¯¹è±¡ç»“æ„ä¸­å¯¹åº”çš„ ```type``` è·Ÿç€çš„æ•°ç»„å¢åŠ ä¸€ä¸ªå›è°ƒå¤„ç†å‡½æ•°ã€‚

é‚£ä¹ˆè¿™ä¸ªä¾‹å­é‡Œé¢çš„æ³„æ¼å±äºéå¸¸éšè”½çš„ä¸€ç§ï¼š```net``` æ¨¡å—çš„é‡è¿æ¯ä¸€æ¬¡éƒ½ä¼šç»™ ```client``` å¢åŠ ä¸€ä¸ª ```connectäº‹ä»¶``` çš„ä¾¦å¬å™¨ï¼Œå¦‚æœä¸€ç›´é‡è¿ä¸ä¸Šï¼Œä¾¦å¬å™¨ä¼šæ— é™å¢åŠ ï¼Œä»è€Œå¯¼è‡´æ³„æ¼ã€‚

### ä¸‰. ä¸æ°å½“çš„å…¨å±€ç¼“å­˜å¯¼è‡´çš„æ³„æ¼

è¿™ä¸ªä¾‹å­å°±æ¯”è¾ƒç®€å•äº†ï¼Œä½†æ˜¯ä¹Ÿå±äºåœ¨å¤±è¯¯æƒ…å†µä¸‹å®¹æ˜“ä¸å°å¿ƒå†™å‡ºæ¥çš„ï¼Œä»¥ä¸‹æ˜¯æ³„æ¼ä»£ç 

```js
'use strict';
const easyMonitor = require('easy-monitor');
const express = require('express');
const app = express();

const _cached = [];

app.get('/arr', function arrayLeak(req, res, next) {
	//æ³„æ¼ä»£ç 
    _cached.push(new Array(1000000));
    res.send('Hello World');
});

app.listen(8082);
```

å¦‚æœæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä¸æ°å½“çš„ä½¿ç”¨äº†å…¨å±€ç¼“å­˜ï¼šä¸»è¦æ˜¯æŒ‡åªæœ‰å¢åŠ ç¼“å­˜çš„æ“ä½œè€Œæ²¡æœ‰æ¸…é™¤çš„æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå¼•èµ·æ³„æ¼ã€‚

è¿™ç§ç¼“å­˜å¼•ç”¨ä¸å½“çš„æ³„æ¼è™½ç„¶ç®€å•ï¼Œä½†æ˜¯æˆ‘æ›¾ç»äº²è‡ªæ’æŸ¥è¿‡ï¼šAppiumè‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ä¸­ï¼ŒæŸä¸€ä¸ªç‰ˆæœ¬çš„æ—¥å¿—ç¼“å­˜ç­–ç•¥æœ‰bugï¼Œå¯¼è‡´æ­å»ºçš„serverè·‘ä¸€æ®µæ—¶é—´å°±é‡å¯ã€‚

## II. å¸¸è§„æ’æŸ¥æ–¹å¼

### ä¸€. heapdump/v8-profiler + chrome dev tools

ç›®å‰nodeä¸Šé¢ç”¨äºæ’æŸ¥å†…å­˜æ³„æ¼çš„è¾…åŠ©å·¥å…·ä¹Ÿæœ‰ä¸€äº›ï¼Œä¸»è¦æ˜¯ï¼š

* heapdump
* v8-profiler

è¿™ä¸¤ä¸ªå·¥å…·çš„åŸç†éƒ½æ˜¯ä¸€è‡´çš„ï¼šè°ƒç”¨v8å¼•æ“æš´éœ²çš„æ¥å£ï¼š
```v8::Isolate::GetCurrent()->GetHeapProfiler()->TakeHeapSnapshot(title, control)```
ç„¶åå°†è·å–çš„c++å¯¹è±¡æ•°æ®è½¬æ¢ä¸ºjså¯¹è±¡ã€‚

è¿™ä¸ªå¯¹è±¡ä¸­å…¶å®å°±æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„jsonï¼Œé€šè¿‡chromeæä¾›çš„dev toolsï¼Œå¯ä»¥å°†è¿™ä¸ªjsonè§£ææˆå¯è§†åŒ–çš„æ ‘æˆ–è€…ç»Ÿè®¡æ¦‚è§ˆå›¾ï¼Œé€šè¿‡å¤šæ¬¡æ‰“å°å†…å­˜ç»“æ„ï¼Œcompareå‡ºåªå¢ä¸å‡çš„å¯¹è±¡ï¼Œæ¥å®šä½åˆ°æ³„æ¼ç‚¹ã€‚

### äºŒ. Easy-Monitorå·¥å…·è‡ªåŠ¨å®šä½ç–‘ä¼¼æ³„æ¼ç‚¹

æˆ‘ä¹‹å‰é¡¹ç›®ä¸­é‡åˆ°ç–‘ä¼¼çš„å†…å­˜æ³„æ¼åŸºæœ¬éƒ½æ˜¯è¿™æ ·æ’æŸ¥çš„ï¼Œä½†æ˜¯æ’æŸ¥çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†å‡ ä¸ªæ¯”è¾ƒå›°æ‰°çš„é—®é¢˜ï¼š

* åªèƒ½åœ¨çº¿ä¸‹è¿›è¡Œï¼Œè€Œçº¿ä¸Šæƒ…å†µå¤æ‚ï¼Œæœ‰äº›é”™è¯¯çº¿ä¸‹å¾ˆéš¾å¤ç°
* æ€»æ˜¯éœ€è¦å¤šæ¬¡æ’å·¥å…·æ‰“å°ï¼Œç„¶åå¯¹æ¯”ï¼Œæ¯”è¾ƒéº»çƒ¦

æ‰€ä»¥åé¢èŠ±äº†ç‚¹æ—¶é—´ï¼Œè¯¦ç»†è§£æäº†ä¸‹v8å¼•æ“è¾“å‡ºçš„heapsnapshoté‡Œé¢çš„jsonç»“æ„ï¼Œåšäº†ä¸€ä¸ªè½»é‡çº§çš„çº¿ä¸Šå†…å­˜æ³„æ¼æ’æŸ¥å·¥å…·ï¼Œä¹Ÿæ˜¯ä¹‹å‰çš„Easy-monitoræ€§èƒ½ç›‘æ§å·¥å…·çš„ä¸€ä¸ªè¡¥å®Œã€‚

å¯¹å¦‚ä½•æµ‹è¯•è‡ªå·±é¡¹ç›®çº¿ä¸Šjsä»£ç æ€§èƒ½ï¼Œä»¥åŠæ‰¾å‡ºjså‡½æ•°å¯ä¼˜åŒ–ç‚¹æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å‚çœ‹è¿™ä¸€ç¯‡ï¼š

* [è½»é‡çº§æ˜“éƒ¨ç½²Nodeæ€§èƒ½ç›‘æ§å·¥å…·ï¼šEasy-Monitor](https://cnodejs.org/topic/58d0dd8b17f61387400b7de5)

æœ¬æ–‡ä¸‹ä¸€èŠ‚ä¸»è¦æ˜¯ä»¥ç¬¬IèŠ‚ä¸­çš„ä¸‰ç§éå¸¸å…¸å‹çš„å†…å­˜æ³„æ¼çŠ¶å†µï¼Œæ¥ä½¿ç”¨æ–°ä¸€ç‰ˆçš„Easy-Monitorè¿›è¡Œç®€å•çš„å®šä½æ’æŸ¥ã€‚

## III. ä½¿ç”¨[Easy-Monitor](https://github.com/hyj1991/easy-monitor)å¿«é€Ÿå®šä½æ³„æ¼ç‚¹

### ä¸€. å®‰è£…&åµŒå…¥é¡¹ç›®

Easy-Monitorçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œå®‰è£…å¯åŠ¨æ€»å…±ä¸‰æ­¥

#### 1.å®‰è£…æ¨¡å—

```
npm install easy-monitor
```

#### 2.å¼•å…¥æ¨¡å—

```
const easyMonitor = require('easy-monitor');
easyMonitor('ä½ çš„é¡¹ç›®åç§°');
```

#### 3.è®¿é—®ç›‘æ§é¡µé¢

æ‰“å¼€ä½ çš„æµè§ˆå™¨ï¼Œè¾“å…¥ä»¥ä¸‹åœ°å€ï¼Œå³å¯çœ‹åˆ°è¿›ç¨‹ç›¸å…³ä¿¡æ¯ï¼š

```
http://127.0.0.1:12333
```

### äºŒ. å†…å­˜æ³„æ¼æ’æŸ¥ä½¿ç”¨æ–¹å¼

Easy-Monitorå¯ä»¥å®æ—¶å±•ç¤ºå†…å­˜åˆ†æä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨çº¿ä¸Šä½¿ç”¨ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä¸‹é¢å°±æ¥ä½¿ç”¨æ­¤å·¥å…·åˆ†æç¬¬IèŠ‚ä¸­å‡ºç°çš„é—®é¢˜ã€‚

#### 1.é—­åŒ…æ³„æ¼

åœ¨é—­åŒ…æ³„æ¼çš„ä»£ç ä¸­ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤å¼•å…¥easy-monitorï¼Œç„¶åä¸åœåœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š

```
http://127.0.0.1:8082/leak
```

é‚£ä¹ˆå‡ æ¬¡åé€šè¿‡topæˆ–è€…åˆ«çš„è‡ªå¸¦å†…å­˜ç›‘æ§å·¥å…·èƒ½çœ‹åˆ°å†…å­˜æ˜æ˜¾ä¸Šå‡ï¼š

![closure_mem_stat.jpeg](//dn-cnode.qbox.me/Fgmg1RSn5JvskDIAdmW43zHygZLX)

è¿™é‡Œæˆ‘æœ¬åœ°è®¿é—®å¤šæ¬¡åï¼Œå·²ç»é£™å‡åˆ°211MBã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Easy-Monitorçš„é¦–é¡µï¼Œç‚¹å‡»å¯¹åº”Pidåé¢çš„ ```MEM``` é“¾æ¥ï¼Œå³å¯è‡ªåŠ¨è¿›è¡Œå½“å‰ä¸šåŠ¡è¿›ç¨‹çš„å †å†…å†…å­˜å¿«ç…§æ‰“å°ä»¥åŠæ³„æ¼ç‚¹åˆ†æï¼š

![index_mem.jpeg](//dn-cnode.qbox.me/FnFrVXTtIRlneHnfJWuK7X-0bgy7)

å¤§çº¦ç­‰å¾…10så·¦å³ï¼Œé¡µé¢å³ä¼šå‘ˆç°å‡ºè§£æçš„ç»“æœã€‚æœ€ä¸Šé¢çš„ ```Heap Status``` ä¸€æ å‘ˆç°çš„å†…å®¹æ˜¯ä¸€ä¸ªå¯¹å½“å‰å †å†…å†…å­˜è§£æåçš„æ¦‚è§ˆï¼Œå¤§æ¦‚çœ‹çœ‹å°±è¡Œäº†ï¼Œæ¯”è¾ƒé‡è¦çš„æ³„æ¼ç‚¹å®šä½åœ¨ä¸‹é¢çš„ ```Memory Leak``` ä¸€æ ã€‚

æˆ‘å¯¹ç–‘ä¼¼çš„å†…å­˜æ³„æ¼ç‚¹æ¨æµ‹æ˜¯ä»è®¡ç®—å¾—åˆ°çš„ ```retainedSize``` ç€æ‰‹çš„ï¼š**æ³„æ¼çš„æ„ŸçŸ¥é¦–å…ˆæ˜¯å†…å­˜æ— æ•…å¢åŠ ï¼Œä¸”åªå¢ä¸å‡ï¼Œé‚£ä¹ˆå½“å‰å †å†…å†…å­˜ç»“æ„ä¸­ä» ```(GC roots)``` èŠ‚ç‚¹å‡ºå‘å¼€å§‹ï¼Œå æ®çš„ ```retainedSize``` æœ€å¤§çš„å°±å¯èƒ½æ˜¯ç–‘ä¼¼æ³„æ¼ç‚¹çš„èµ·å§‹ã€‚**

éµå¾ªè¿™ä¸ªè§„åˆ™ï¼Œ```Memory Leak``` ç¬¬ä¸€ä¸ªå­æ ç›®å¾—åˆ°çš„æ˜¯ç–‘ä¼¼æ³„æ¼ç‚¹çš„æ¦‚è§ˆï¼š

![closure_mem_point_index.jpeg](//dn-cnode.qbox.me/Fk_Ujb1sH0Ah5vCIjugez7f8wPt_)

è¿™é‡ŒæŒ‰ç…§ ```retainedSize``` å¤§å°åšäº†ä»å¤§åˆ°å°çš„æ’åºï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™å‡ ä¸ªç‚¹åŸºæœ¬ä¸Šå æ®äº†90%ä»¥ä¸Šçš„å †å†…å†…å­˜å¤§å°ã€‚

å¥½äº†ï¼Œä¸‹é¢çš„å­æ ç›®åˆ™æ˜¯å¯¹è¿™é‡Œé¢çš„5ä¸ªç–‘ä¼¼æ³„æ¼ç‚¹æ„å»º **å¼•åŠ›å›¾**ï¼Œæ¥æ‰¾å‡ºæ³„æ¼é“¾æ¡ï¼ŒåŸç†å’Œå‰é¢ä¸€æ ·ï¼š**å æ®æ€»å †å†…å†…å­˜ ```retainedSize``` æœ€å¤§çš„å¯¹è±¡ä¸‹é¢ä¸€å®šä¹Ÿæœ‰å æ®å…¶ ```retainedSize``` æœ€å¤§çš„èŠ‚ç‚¹**ï¼š

![closure_mem_force.jpeg](//dn-cnode.qbox.me/FmGdeY1c_5QEMjmOFaePN7fU-DRD)

æ ¹æ®å¼•åŠ›å›¾å¯ä»¥å¾ˆæ¸…æ™°çœ‹åˆ° ```retainedSize``` æœ€å¤§çš„ç–‘ä¼¼æ³„æ¼é“¾æ¡ï¼Œé¢œè‰²å’Œå¤§å°çš„ä¸€éƒ¨åˆ†å«ä¹‰ï¼š

* è“è‰²è¡¨ç¤ºç–‘ä¼¼çš„æ³„æ¼èŠ‚ç‚¹
* ç´«è‰²è¡¨ç¤ºæ™®é€šèŠ‚ç‚¹
* æœ€å¤§çš„èŠ‚ç‚¹è¡¨ç¤ºçš„æ˜¯å½“å‰ç–‘ä¼¼æ³„æ¼é“¾æ¡çš„æ ¹èŠ‚ç‚¹

è¿™é‡Œçš„å±•ç¤ºç”¨äº†Echarts2ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½å¯ä»¥ç‚¹å‡»å±•å¼€/æŠ˜å ã€‚å½“æˆ‘ä»¬æŠŠé¼ æ ‡ç§»åŠ¨åˆ°ç–‘ä¼¼æ³„æ¼é“¾æ¡çš„æœ€åä¸€ä¸ªå­èŠ‚ç‚¹æ—¶ï¼Œå¼•åŠ›å›¾ä¸‹é¢ä¼šç”¨æ–‡å­—æ˜¾ç¤ºå‡ºå½“å‰çš„æ³„æ¼é“¾æ¡çš„è¯¦ç»†æŒ‡å‘ä¿¡æ¯ ```Reference List``` ï¼Œè¿™é‡Œç®€å•çš„è§£æä¸‹å…¶å†…å®¹ï¼š

```bash
[object] (Route::@122187) ' stack 
---> [object] (Array::@124261) ' [0] 
---> [object] (Layer::@124265) ' handle 
---> [closure] (closureLeak::@124169) ' context 
---> [object] (system / Context::@84427) ' theThing 
---> [object] (Object::@122271) ' someMethod 
---> [closure] (someMethod::@122275) ' context 
---> [object] (system / Context::@122269) ' leak 
---> [object] (Object::@122113) ' someMethod 
---> [closure] (someMethod::@122117) ' context 
---> [object] (system / Context::@122111)
```

æ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªèŠ‚ç‚¹ï¼š**[ç±»å‹] \(åç§°::èŠ‚ç‚¹å”¯ä¸€id\) ' å±æ€§åç§°æˆ–è€…index**ã€‚
å› ä¸ºæµ‹è¯•ä»£ç ç”¨äº†Expressæ¡†æ¶ï¼Œç†Ÿæ‚‰Expressæ¡†æ¶æºç çš„å°ä¼™ä¼´éƒ½èƒ½çœ‹å‡ºæ¥äº†ï¼š

* æ ¹èŠ‚ç‚¹æ˜¯åˆå§‹åŒ–expressæ—¶æ„é€ çš„ ```Route``` çš„å®ä¾‹ã€‚
* è¯¥ ```Route``` å®ä¾‹çš„ ```stack``` å±æ€§å¯¹åº”çš„æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå³è¿™é‡Œçš„ ```[0]``` å¯¹åº”çš„å…ƒç´ ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ‰€ä»¥æ˜¯ ```Layer``` çš„ä¸€ä¸ªå®ä¾‹ã€‚
* è¯¥ä¸­é—´ä»¶çš„ ```handle``` å±æ€§æŒ‡å‘ **```closureLeak``` å‡½æ•°**ï¼Œè¿™é‡Œå¼€å§‹å‡ºç°æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„Expressæ¡†æ¶å¤–çš„ä»£ç äº†ï¼Œç®€å•åˆ†æä¸‹ä¹Ÿå¾ˆå®¹æ˜“æ˜ç™½è¿™ä¸ªä¸­é—´ä»¶å…¶å®å°±æ˜¯æˆ‘ä»¬ç¼–å†™çš„ ```app.get``` éƒ¨åˆ†ã€‚
* ```closureLeak``` å‡½æ•°æŒæœ‰äº†ä¸Šçº§ä½œç”¨åŸŸäº§ç”Ÿçš„é—­åŒ…å¯¹è±¡ï¼Œè¿™ä¸ªé—­åŒ…å¯¹è±¡ä¸­ ```retainedSize``` æœ€å¤§çš„å˜é‡ä¸º ```theThing```
* ```theThing``` æŒæœ‰äº† ```someMethod``` çš„å¼•ç”¨ï¼Œ**```someMethod``` åˆé€šè¿‡ä¸Šçº§ä½œç”¨åŸŸçš„é—­åŒ…å¯¹è±¡æŒæœ‰äº† ```leak``` å˜é‡ï¼Œ```leak``` å˜é‡åˆæŒ‡å‘ ```theThing``` å˜é‡æŒ‡å‘çš„ä¸Šä¸€æ¬¡çš„è€å¯¹è±¡ï¼Œè¿™ä¸ªè€å¯¹è±¡ä¸­ä¾æ—§åŒ…å«äº† ```someMethod``` ...**

é€šè¿‡è¿™ä¸ªå¼•åŠ›å›¾å’Œä¸‹é¢æä¾›çš„ ```Reference List``` åˆ†æï¼Œå…¶å®å¾ˆå®¹æ˜“å‘ç°æ³„æ¼ç‚¹å’Œæ³„æ¼åŸå› ï¼šæ­£æ˜¯å› ä¸ºç¬¬IèŠ‚ä¸­æåˆ°çš„v8å¼•æ“ä½œç”¨åŸŸç”Ÿæˆå’ŒæŒæœ‰é—­åŒ…å¼•ç”¨çš„è§„åˆ™ï¼Œé‚£ä¹ˆ ```unused``` å‡½æ•°çš„å­˜åœ¨ï¼Œå¯¼è‡´äº† ```leak``` å˜é‡è¢« ```replaceThing``` å‡½æ•°ä½œç”¨åŸŸç”Ÿæˆçš„é—­åŒ…å¯¹è±¡å­˜å‚¨äº†ï¼Œé‚£ä¹ˆ ```theThing``` æ¯ä¸€æ¬¡æŒ‡å‘çš„æ–°å¯¹è±¡é‡Œé¢çš„ ```someMethod``` å‡½æ•°æŒæœ‰äº†è¿™ä¸ªé—­åŒ…å¯¹è±¡ï¼Œå› æ­¤é—´æ¥æŒæœ‰äº†ä¸Šä¸€æ¬¡è®¿é—® ```theThing``` æŒ‡å‘çš„è€å¯¹è±¡ã€‚æ‰€ä»¥æ¯ä¸€æ¬¡è®¿é—®åï¼Œè€å¯¹è±¡æ°¸è¿œå› ä¸ºè¢«æŒæœ‰æ°¸è¿œæ— æ³•å¾—åˆ°é‡Šæ”¾ï¼Œä»è€Œå¼•èµ·äº†æ³„æ¼ã€‚

è¿™é‡Œä¹ŸæŠŠå…³é”®è¯æ•´ç†å‡ºæ¥ï¼Œæ–¹ä¾¿å¤§å®¶é¡¹ç›®å…¨å±€æœç´¢æ’æŸ¥ï¼š**Leak Key**

#### 2.Socketé‡è¿æ³„æ¼

åŒæ ·çš„æ–¹å¼ï¼Œç¬¬IèŠ‚ä¸­çš„ä»£ç ä¿å­˜åæ‰§è¡Œï¼Œæ³¨æ„ ```connect``` æ“ä½œçš„ç«¯å£å¡«å†™ä¸€ä¸ªæœ¬åœ°ä¸å­˜åœ¨çš„ç«¯å£ï¼Œæ¥æ¨¡æ‹Ÿè§¦å‘å®¢æˆ·ç«¯çš„æ–­çº¿é‡è¿ã€‚

é‚£ä¹ˆè¿™æ®µä»£ç è·‘å¤§æ¦‚ä¸€åˆ†é’Ÿå·¦å³ï¼Œå³å¼€å§‹äº§ç”Ÿæ¯”è¾ƒæ˜æ˜¾çš„æ³„æ¼ç°è±¡ã€‚åŒæ ·æ‰“å¼€easy-monitorç›‘æ§é¡µé¢è¿›è¡Œå †å†…å­˜åˆ†æï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

![socket_mem_index.jpeg](//dn-cnode.qbox.me/FskCsNhsPFQnxMPquniyvJNovA-2)

è¿™ä¸ªå›¾å¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼Œå æ® ```retainedSize``` æœ€å¤§çš„å¯¹è±¡æ­£æ˜¯ ```socket``` å¯¹è±¡ï¼Œå‡ ä¹å åˆ°äº†å †å†…æ€»å†…å­˜çš„ 50% ä»¥ä¸Šã€‚

æ¥ç€å¾€ä¸‹çœ‹å¼•åŠ›å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![socket_mem_force.jpeg](//dn-cnode.qbox.me/Fm62hb6Ga3inyqI8eJugQvj-sE62)

å…¶ä¸­çš„ ```Reference List``` å¦‚ä¸‹ï¼š

```bash
[object] (Socket::@97097) ' _events
---> [object] (EventHandlers::@97101) ' connect 
---> [object] (Array::@102511)
```
è¿™é‡Œç†Ÿæ‚‰Nodeæ ¸å¿ƒæ¨¡å— ```events``` çš„å°ä¼™ä¼´å°±èƒ½æ„Ÿåˆ°ç†Ÿæ‚‰ï¼Œ```_events``` æ­£æ˜¯å­˜å‚¨è®¢é˜…äº‹ä»¶/äº‹ä»¶å›è°ƒå‡½æ•°çš„å±æ€§ï¼Œé‚£ä¹ˆè¿™è¾¹å¾ˆæ˜¾ç„¶æ˜¯åŸç”Ÿçš„socketè§¦å‘æ–­çº¿é‡è¿æ—¶ï¼Œä¼šä¸åœå¢åŠ  ```connect``` äº‹ä»¶çš„å¤„ç†ï¼Œå¦‚æœæœåŠ¡å™¨ä¸€ç›´æŒ‚æ‰ï¼Œå³å®¢æˆ·ç«¯æ— æ³•æ–­çº¿é‡è¿æˆåŠŸï¼Œé‚£ä¹ˆå†…å­˜å°±ä¼šä¸æ–­å¢åŠ å¯¼è‡´æ³„æ¼ã€‚

é¢˜å¤–æ’ä¸€å¥ï¼Œæˆ‘ç¿»äº†ä¸‹net.jsçš„ä»£ç ï¼Œè¿™é‡Œçš„ ```connect``` äº‹ä»¶æ˜¯ä»¥ ```once``` çš„æ–¹å¼æ·»åŠ çš„ï¼Œæ‰€ä»¥åªè¦é‡è¿è¿‡ç¨‹ä¸­èƒ½å¤Ÿè¿ä¸Šä¸€æ¬¡ï¼Œè¿™éƒ¨åˆ†ä¾¦å¬å™¨å¢åŠ çš„å†…å­˜å°±èƒ½å¤Ÿè¢«å›æ”¶æ‰ã€‚

#### 3.å…¨å±€ç¼“å­˜æ³„æ¼

è¿™ä¸ªæ˜¯æœ€ç®€å•çš„åŸå› äº†ï¼Œå¤§å®¶å¯ä»¥ä½¿ç”¨Easy-Monitorè‡ªè¡Œå°è¯•ä¸€ç•ª~

## IV. å¦‚ä½•ä¿®æ”¹é¿å…æ³„æ¼

### ä¸€. æ–­æ‰é—­åŒ…ä¸­çš„æ³„æ¼å˜é‡å¼•ç”¨é“¾æ¡

æ ¹æ®ç¬¬IIIèŠ‚ä¸­çš„è§£æï¼Œæ˜ç™½äº†è¿™ç§æ³„æ¼çš„åŸç†ï¼Œå°±æ¯”è¾ƒå®¹æ˜“å¯¹ä»£ç è¿›è¡Œä¿®æ”¹äº†ï¼Œæ–­æ‰ ```unused``` å‡½æ•°å¯¹ ```leak``` å˜é‡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆ ```replaceThing``` å‡½æ•°ä½œç”¨åŸŸçš„é—­åŒ…å¯¹è±¡ä¸­å°±ä¸ä¼šæœ‰ ```leak``` å˜é‡äº†ï¼Œè¿™æ · ```someMethod``` å³ä¸ä¼šå†å¯¹è€å¯¹è±¡é—´æ¥äº§ç”Ÿå¼•ç”¨å¯¼è‡´æ³„æ¼ï¼Œä¿®æ”¹åä»£ç å¦‚ä¸‹ï¼š

```js
'use strict';
const express = require('express');
const app = express();
const easyMonitor = require('easy-monitor');
easyMonitor('Closure Leak');

let theThing = null;
let replaceThing = function () {
    let leak = theThing;
    //æ–­æ‰leakçš„é—­åŒ…å¼•ç”¨å³å¯è§£å†³è¿™ç§æ³„æ¼
    let unused = function (leak) {
        if (leak)
            console.log("hi")
    };

    theThing = {
        longStr: new Array(1000000),
        someMethod: function () {
            console.log('a');
        }
    };
};

app.get('/leak', function closureLeak(req, res, next) {
    replaceThing();
    res.send('Hello Node');
});

app.listen(8082);

```

### äºŒ. æ–­çº¿é‡è¿æ—¶å»æ‰è€ä¾¦å¬å™¨

ä¿®æ”¹ä¸»è¦ç›®çš„æ˜¯åœ¨é‡è¿æ—¶å»æ‰è¿æ¥å¤±è´¥æ—¶æ·»åŠ çš„ ```connect``` äº‹ä»¶ï¼Œä¿®æ”¹åä»£ç å¦‚ä¸‹ï¼š

```js
const net = require('net');
const easyMonitor = require('easy-monitor');
easyMonitor('Socket Leak');
let client = new net.Socket();

function callbackListener() {
    console.log('connected!');
});

function connect() {
    client.connect(26665, '127.0.0.1', callbackListener}

connect();

client.on('error', function (error) {
    // console.error(error.message);
});

client.on('close', function () {
    //console.error('closed!');
    //æ–­çº¿æ—¶å»æ‰æœ¬æ¬¡ä¾¦å¬çš„connectäº‹ä»¶çš„ä¾¦å¬å™¨
    client.removeListener('connect', callbackListener);
    client.destroy();
    setTimeout(connect, 1);
});

```

### ä¸‰.

ä¿®æ”¹å’Œæµ‹è¯•å¤§å®¶å¯ä»¥è‡ªè¡Œå°è¯•ä¸€ç•ªã€‚

## V. ç»“è¯­

åšè¿™ä¸ªå·¥å…·ä¹Ÿè®©è‡ªå·±å¯¹äºv8çš„å†…å­˜ç®¡ç†æœ‰äº†æ›´æ·±å…¥çš„è®¤è¯†ï¼Œæ”¶è·æŒºå¤§çš„ï¼Œä¸‹ä¸€æ­¥çš„è®¡åˆ’æ˜¯ä¼˜åŒ–ä»£ç é€»è¾‘å’Œå‰å°å‘ˆç°ç•Œé¢ï¼Œæé«˜æ˜“ç”¨æ€§å’Œå¼€å‘è€…çš„ä½“éªŒã€‚

Easy-Monitoræ–°ç‰ˆæœ¬ä¸‹ä¾æ—§æ”¯æŒçº¿ä¸Šéƒ¨ç½²å’Œå¤šé¡¹ç›®clusteréƒ¨ç½²ï¼Œæœ€åé¡¹ç›®çš„gitåœ°å€åœ¨ï¼š

[Easy-Monitor](https://github.com/hyj1991/easy-monitor)

å¦‚æœå¤§å®¶è§‰å¾—æœ‰å¸®åŠ©æˆ–è€…ä¸é”™ï¼Œæ¬¢è¿ç»™ä¸ªstar ğŸ’•~